---
- hosts: k3s_cluster
  become: true
  tasks:
    # linux-generic is required for iGPU passthrough
    - name: Install linux-generic package
      ansible.builtin.apt:
        name: linux-generic
        state: present

    # Longhorn RWX support requirement
    - name: Install nfs-common package
      ansible.builtin.apt:
        name: nfs-common
        state: present

    # https://github.com/longhorn/longhorn/issues/1210
    - name: Add Longhorn devices to multipathd blacklist
      ansible.builtin.blockinfile:
        path: /etc/multipath.conf
        create: true
        block: |
          blacklist {
              devnode "^sd[a-z0-9]+"
          }
      register: multipath_conf

    - name: Restart multipathd service
      ansible.builtin.systemd:
        name: multipathd.service
        state: restarted
      when: multipath_conf.changed

- hosts: workers
  become: true
  tasks:
    # setup longhorn disk
    - name: Create a new ext4 primary partition
      community.general.parted:
        device: /dev/sdb
        number: 1
        state: present
        fs_type: ext4
        label: gpt
        name: longhorn

    - name: Create a ext4 filesystem on /dev/sdb1
      community.general.filesystem:
        dev: /dev/sdb1
        fstype: ext4

    - name: Mount up device by label
      ansible.posix.mount:
        path: /var/lib/longhorn
        src: PARTLABEL=longhorn
        fstype: ext4
        state: mounted
