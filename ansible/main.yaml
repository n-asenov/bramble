---
- name: Enable cgroups
  hosts: k3s_cluster
  become: yes
  tasks:
  - name: Append cgroup cmdline arguments
    ansible.builtin.lineinfile:
      path: /boot/cmdline.txt
      regexp: '^((?!.*\bcgroup_memory=1 cgroup_enable=memory\b).*)$'
      line: '\1 cgroup_memory=1 cgroup_enable=memory'
      backrefs: true

- name: Configure PoE hat fan speed
  hosts: k3s_cluster
  become: yes
  tasks:
  - name: Configure PoE hat fan speed
    ansible.builtin.blockinfile:
      path: /boot/config.txt
      block: |
        # PoE+ hat fan speed
        dtparam=poe_fan_temp0=65000
        dtparam=poe_fan_temp1=70000
        dtparam=poe_fan_temp2=75000
        dtparam=poe_fan_temp3=80000

- name: Install iscsi
  hosts: k3s_cluster
  become: yes
  tasks:
  - name: Install iscsi
    ansible.builtin.apt:
      name: open-iscsi
      state: present

- name: Increase swap size
  hosts: k3s_cluster
  become: yes
  tasks:
  - name: Disable swap
    ansible.builtin.command: dphys-swapfile swapoff
  - name: Disable staic swap size calculation
    ansible.builtin.lineinfile:
      path: /etc/dphys-swapfile
      regexp: '^(CONF_SWAPSIZE=100)$'
      line: '# \1'
      backrefs: true
      backup: true
  - name: Enable dynamic swap size calculation
    ansible.builtin.lineinfile:
      path: /etc/dphys-swapfile
      regexp: '^#.?CONF_SWAPFACTOR=\d$'
      line: 'CONF_SWAPFACTOR=1'
      backrefs: true
      backup: true
  - name: Init swap
    ansible.builtin.command: dphys-swapfile setup
  - name: Enable swap
    ansible.builtin.command: dphys-swapfile swapon
