# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: homepage
spec:
  interval: 10m0s
  chart:
    spec:
      chart: app-template
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      version: 3.7.0
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    defaultPodOptions:
      enableServiceLinks: true
      securityContext:
        runAsUser: 568
        runAsGroup: 568
        fsGroup: 568
        fsGroupChangePolicy: "OnRootMismatch"

    controllers:
      homepage:
        containers:
          app:
            image:
              repository: ghcr.io/gethomepage/homepage
              tag: v0.10.9
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 1Gi

          # codeserver:
          #   dependsOn: app
          #   image:
          #     repository: ghcr.io/coder/code-server
          #     tag: 4.96.4
          #   env:
          #     TZ: Europe/Sofia
          #   args:
          #     - --auth
          #     - "none"
          #     - --user-data-dir
          #     - "/app/config/.vscode"
          #     - --extensions-dir
          #     - "/app/config/.vscode"
          #     - "/app/config"
          #   resources:
          #     requests:
          #       cpu: 100m
          #     limits:
          #       memory: 256Mi

    service:
      app:
        controller: homepage
        primary: true
        ports:
          http:
            port: 80
            targetPort: 3000
      # codeserver:
      #   controller: homepage
      #   primary: false
      #   type: ClusterIP
      #   ports:
      #     http:
      #       port: 80
      #       targetPort: 8080

    ingress:
      app:
        className: nginx
        hosts:
          - host: homepage.nasenov.dev
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
        tls:
          - hosts:
              - homepage.nasenov.dev
      # codeserver:
      #   className: nginx
      #   hosts:
      #     - host: homepage-code.nasenov.dev
      #       paths:
      #         - path: /
      #           pathType: Prefix
      #           service:
      #             identifier: codeserver
      #             port: http
      #   tls:
      #     - hosts:
      #         - homepage-code.nasenov.dev

    persistence:
      config:
        type: configMap
        name: homepage-config
        globalMounts:
          - path: /app/config
      logs:
        type: emptyDir
        globalMounts:
          - path: /app/config/logs   
      # config:
      #   enabled: true
      #   type: persistentVolumeClaim
      #   storageClass: ceph-block
      #   accessMode: ReadWriteOnce
      #   dataSourceRef:
      #     apiGroup: volsync.backube
      #     kind: ReplicationDestination
      #     name: homepage-dst
      #   size: 1Gi
      #   globalMounts:
      #     - path: /app/config

    configMaps:
      config:
        enabled: true
        data:
          bookmarks.yaml: |
            ---
          custom.css: ""
          custom.js: ""
          docker.yaml: |
            ---
          kubernetes.yaml: |
            ---
            mode: disabled
          services.yaml: |
            ---
            - Automation:
                - Zigbee2MQTT:
                    icon: zigbee2mqtt.png
                    href: https://zigbee.nasenov.dev
                - EMQX:
                    icon: emqx.png
                    href: https://emqx.nasenov.dev
          settings.yaml: |
            ---
            background: https://images.unsplash.com/photo-1502790671504-542ad42d5189?auto=format&fit=crop&w=2560&q=80
            # theme: dark
            # color: slate
            hideVersion: true

            # fiveColumns: true
            disableCollapse: true

            layout:
              Media:
                style: row
                columns: 4
              Infrastructure:
                style: row
                columns: 2
              Monitoring:
                style: row
                columns: 4
              Automation:
                style: row
                columns: 4
          widgets.yaml: |
            ---
            - logo:
                icon: homepage.png
